::Author:远景论坛Jay1982
::Blog: https://www.cnblogs.com/1982/
::QQ:1438411802
@ECHO OFF
IF EXIST "%WinDir%\SysWOW64" set "OS_ARCHITECTURE=x64"
IF NOT EXIST "%WinDir%\SysWOW64" set "OS_ARCHITECTURE=x86"
IF EXIST "%SYSTEMDRIVE%\drv\WanDrv6(Win7.%OS_ARCHITECTURE%).exe" Start /wait %SYSTEMDRIVE%\drv\WanDrv6(Win7.%OS_ARCHITECTURE%).exe /fa /c
IF EXIST "%SYSTEMDRIVE%\drv\EasyDrv7(Win7.%OS_ARCHITECTURE%).exe" (
    Reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows\Safer\CodeIdentifiers" /v "AuthenticodeEnabled" /t REG_DWORD /d "1" /f
    Reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows\Safer\CodeIdentifiers" /v "TransparentEnabled" /t REG_DWORD /d "2" /f
    Reg add "HKLM\SOFTWARE\Policies\Microsoft\SystemCertificates\Disallowed\Certificates\297124A7E7D4F2B46BD478AC7263A1369AC1738D" /v "Blob" /t REG_BINARY /d "030000000100000014000000297124A7E7D4F2B46BD478AC7263A1369AC1738D0D000000010000000200000000001B00000001000000080000005029612C82CAD201200000000100000029050000308205253082040DA00302010202100BD5153703D8D5F81FEF761969009A14300D06092A864886F70D01010B0500307F310B3009060355040613025553311D301B060355040A131453796D616E74656320436F72706F726174696F6E311F301D060355040B131653796D616E746563205472757374204E6574776F726B3130302E0603550403132753796D616E74656320436C61737320332053484132353620436F6465205369676E696E67204341301E170D3136303132383030303030305A170D3139303332383233353935395A3081BC310B300906035504061302434E3112301006035504080C094775616E67646F6E673111300F06035504070C085368656E7A68656E31353033060355040A0C2C54656E63656E7420546563686E6F6C6F6779285368656E7A68656E2920436F6D70616E79204C696D6974656431183016060355040B0C0FE7A094E58F91E7AEA1E79086E983A83135303306035504030C2C54656E63656E7420546563686E6F6C6F6779285368656E7A68656E2920436F6D70616E79204C696D6974656430820122300D06092A864886F70D01010105000382010F003082010A0282010100F325005E7A9B96D37C363B24162FBB5558CC3AE986D5A57BFA41670C98576ED94134CCAD40FD67E89C474C5363D15DDCBC7FA3A140D99B783E973C121A54C9D41742822E80BD0584E232DBF06C78A70C0BE0AB8FD69F2811CDBC78A5103F612C59D200576A58DD50C673AABC9D4CFA2676FAE1A7326B56DCA5546B82C7EE8E00C2614D11F5C5301E0F67099176D8D4F0FF864BE9B8DE77FCF97A0B0EF92A204595C38EF87CB7AA6409874F152718C330B22D4AABE5358415FFB8996648641A2FEDC5254242B6C8B88A3067E303AF5019B602938FD896DE6E5E20871BA48E91FD475B72405D1B6FA9431320FBCC03690BB88368D405A533D736A4E99112FD41DD0203010001A382015D3082015930090603551D1304023000300E0603551D0F0101FF040403020780302B0603551D1F042430223020A01EA01C861A687474703A2F2F73762E73796D63622E636F6D2F73762E63726C30610603551D20045A30583056060667810C010401304C302306082B06010505070201161768747470733A2F2F642E73796D63622E636F6D2F637073302506082B0601050507020230190C1768747470733A2F2F642E73796D63622E636F6D2F72706130130603551D25040C300A06082B06010505070303305706082B06010505070101044B3049301F06082B060105050730018613687474703A2F2F73762E73796D63642E636F6D302606082B06010505073002861A687474703A2F2F73762E73796D63622E636F6D2F73762E637274301F0603551D23041830168014963B53F0793397AF7D83EF2E2BCCCAB7861E7266301D0603551D0E041604143429883B061F649394983AE0E9516D9B5FA05B06300D06092A864886F70D01010B0500038201010006D22DED1F55EF5AEA812139894963B6C8919F58C72145A8C3C0D966635954610DD936C485AE55E25A829A76B2851E95819CDC05717F16556811CF1FF9F41307181FD230803D9DF4F52230C1E5E5D31511FE8D33C4C5D1D487467CC069800288D044517C1ECB92443F221BEFD913FCE6AC727D3721C825F77BCDDA6B2D534EADDF807EA0874A1DB1E72D32AE4CD2A57D0F3796CF87EBF8D5538128DCA3D7E3BFC0092297E4193EB2D62FC9D19909A0B0D6E14C4CC9C59F035605089434A93D792E5C0BE695B0F6A5D003015DD55344B26FF507734305D9200856EA53586447ACE184ECE1F749DC687C0238EA0B53D9ED7A2F6E890DDDDC26FEC06F00C9E2ED76" /f
    Reg add "HKLM\SOFTWARE\Policies\Microsoft\SystemCertificates\Disallowed\Certificates\3324A9FDE3F75FEA3DACDD5EA73037CF5931201C" /v "Blob" /t REG_BINARY /d "0300000001000000140000003324A9FDE3F75FEA3DACDD5EA73037CF5931201C0D000000010000000200000000001B000000010000000800000040C4352782CAD2012000000001000000E5040000308204E1308203C9A00302010202107DA408C5B0A9B322083D3F74EAE74505300D06092A864886F70D01010B0500307F310B3009060355040613025553311D301B060355040A131453796D616E74656320436F72706F726174696F6E311F301D060355040B131653796D616E746563205472757374204E6574776F726B3130302E0603550403132753796D616E74656320436C61737320332053484132353620436F6465205369676E696E67204341301E170D3136303232333030303030305A170D3137303930323233353935395A3079310B300906035504061302434E3111300F06035504080C087368616E676861693111300F06035504070C087368616E676861693111300F060355040A0C08323334352E636F6D311E301C060355040B0C15E6A18CE99DA2E8BDAFE4BBB6E4BA8BE4B89AE983A83111300F06035504030C08323334352E636F6D30820122300D06092A864886F70D01010105000382010F003082010A0282010100CD112E80595487B9F828943A33DB2FE88867C318D2C0D07A6C1B23A50934A3AA36843D957D9B5275D89BB0FD2F949F5F465240C65904BDEBF381C054ED9646C98D6E6275FBC3D92779A217603F3FBB3FFCAA388EF975B28C9B92EA3D67015BFBC0EC7C38E2A429A7F9D6D112B11DFB431915785F1AEFF1AD1604045934DE112E90E6725ED0A190D3A2EFD839881A1DFF2980F39EA7110FE36252BF9199EF1DA1E81034A7B8AE5F18AD9AC6A4A22B3DA53FC0C9DB7644EED4B5B1D795915E3D9D13B820B1839552CE3C2C04FADCB1BEC771E5FE94B68A3BF1E5895E782C74B631E5BBCFE50F0094E8B68FE4EBDBD79E2BFBF92F4E27E13978C4449D8C0C63E44F0203010001A382015D3082015930090603551D1304023000300E0603551D0F0101FF040403020780302B0603551D1F042430223020A01EA01C861A687474703A2F2F73762E73796D63622E636F6D2F73762E63726C30610603551D20045A30583056060667810C010401304C302306082B06010505070201161768747470733A2F2F642E73796D63622E636F6D2F637073302506082B0601050507020230190C1768747470733A2F2F642E73796D63622E636F6D2F72706130130603551D25040C300A06082B06010505070303305706082B06010505070101044B3049301F06082B060105050730018613687474703A2F2F73762E73796D63642E636F6D302606082B06010505073002861A687474703A2F2F73762E73796D63622E636F6D2F73762E637274301F0603551D23041830168014963B53F0793397AF7D83EF2E2BCCCAB7861E7266301D0603551D0E041604140F4C8CB79590D6BCAC8495450A95EEE0BDD1F66C300D06092A864886F70D01010B0500038201010036B4CE1E8D28E82C472FEE399068CFB77894F73C70E6A373EFA43DB7D8859EF9974FE2961041E99296BB940DDBE60979C4B06D5E98D0075E79CF20F0F14400FCFA29750E40F75E75DB2BE8D6FF24E11BB6E633751746CCD0CA4ACD6D28E4A325DA0E5BAAE075CB8D69B8DDFA6BD5C07D7C5248DB0499890C8965F5ABA88B0B3BD8357459AC18BA39F9D3115DE638163F8B9316CC6A990B6C1BF33660E29D8C97E1A0C33EB5D21CFA227E49211268470BA4C9E2366FA3803513CCC7CB8B0E308A37538AA2D79BF17B01F00B6D99C000CD0EF7289EFFACACB2BC3BCBAEEEC686411954F84C77516F1F73E109FEE9C5AF730279F4A32C9E57D268EA906CA90ADD93" /f
    Reg add "HKLM\SOFTWARE\Policies\Microsoft\SystemCertificates\Disallowed\Certificates\65439929B67973EB192D6FF243E6767ADF0834E4" /v "Blob" /t REG_BINARY /d "03000000010000001400000065439929B67973EB192D6FF243E6767ADF0834E40D000000010000000200000000001B000000010000000800000000D81E1F82CAD2012000000001000000A7040000308204A33082038BA00302010202100ECFF438C8FEBF356E04D86A981B1A50300D06092A864886F70D0101050500305E310B3009060355040613025553311D301B060355040A131453796D616E74656320436F72706F726174696F6E3130302E0603550403132753796D616E7465632054696D65205374616D70696E67205365727669636573204341202D204732301E170D3132313031383030303030305A170D3230313232393233353935395A3062310B3009060355040613025553311D301B060355040A131453796D616E74656320436F72706F726174696F6E313430320603550403132B53796D616E7465632054696D65205374616D70696E67205365727669636573205369676E6572202D20473430820122300D06092A864886F70D01010105000382010F003082010A0282010100A2630B3944B8BB23A74449BB0EFFA1F0610A5393B098DBAD2C0F4AC56EFF863C53550F15CE043F2BFDA99696D9BE61790B5BC94C8676E5E0434B2295EEC22B43C19FD868B48E404FEE8538B911C523F26458F015326F4E57A1AE88A402D72A1ECD4BE1DD63D51789325BB05E995AA89D28500E17EE96DB613B45511DCF12560B9247FCABAEF6663D47AC7072E792E75FCD10B9C483649419BD2580E1E8D222A5D0BA027AA177935B65C3EE1774BC41862ADC084C8C928C912D9E77441F68D6A87477DB0E5B328B568B33BDD963C8499D3AC5C5EA330BD2F1A31BF48BBED9B3578B3BDE04A77A22B224AE2EC770C5BE4E832608FB0BBDA94F9908E1102872AACD0203010001A382015730820153300C0603551D130101FF0402300030160603551D250101FF040C300A06082B06010505070308300E0603551D0F0101FF040403020780307306082B0601050507010104673065302A06082B06010505073001861E687474703A2F2F74732D6F6373702E77732E73796D616E7465632E636F6D303706082B06010505073002862B687474703A2F2F74732D6169612E77732E73796D616E7465632E636F6D2F7473732D63612D67322E636572303C0603551D1F043530333031A02FA02D862B687474703A2F2F74732D63726C2E77732E73796D616E7465632E636F6D2F7473732D63612D67322E63726C30280603551D110421301FA41D301B311930170603550403131054696D655374616D702D323034382D32301D0603551D0E0416041446C669A30E4A141ED54CDA5263173F5E36BC0DE6301F0603551D230418301680145F9AF56E5CCCCC749AD4DD7DEF3FDBEC4C802EDD300D06092A864886F70D01010505000382010100783BB4912A004CF08F62303778A38427076F18B2DE25DCA0D49403AA864E259F9A40031CDDCEE379CB216806DAB632B46DBFF42C266333E449646D0DE6C3670EF705A4356C7C8916C6E9B2DFB2E9DD20C6710FCD9574DCB65CDEBD371F4378E678B5CD280420A3AAF14BC48829910E80D111FCDD5C766E4F5E0E4546416E0DB0EA389AB13ADA097110FC1C79B4807BAC69F4FD9CB60C162BF17F5B093D9B5BE216CA13816D002E380DA8298F2CE1B2F45AA901AF159C2C2F491BDB22BBC3FE789451C386B182885DF03DB451A179332B2E7BB9DC20091371EB6A195BCFE8A530572C89493FB9CF7FC9BF3E226863539ABD6974ACC51D3C7F92E0C3BC1CD80475" /f
    Reg add "HKLM\SOFTWARE\Policies\Microsoft\SystemCertificates\Disallowed\Certificates\C57B841B09620EA6278E62AF20963FAEC8F9E03D" /v "Blob" /t REG_BINARY /d "030000000100000014000000C57B841B09620EA6278E62AF20963FAEC8F9E03D0D000000010000000200000000001B000000010000000800000010E7E02982CAD20120000000010000005F0500003082055B30820443A003020102021052048B9C8A67E28F0CC8CC75813DDC5A300D06092A864886F70D01010505003081B4310B300906035504061302555331173015060355040A130E566572695369676E2C20496E632E311F301D060355040B1316566572695369676E205472757374204E6574776F726B313B3039060355040B13325465726D73206F66207573652061742068747470733A2F2F7777772E766572697369676E2E636F6D2F727061202863293130312E302C06035504031325566572695369676E20436C617373203320436F6465205369676E696E672032303130204341301E170D3136303230343030303030305A170D3139303332383233353935395A3081BC310B300906035504061302434E3112301006035504080C094775616E67646F6E673111300F06035504070C085368656E7A68656E31353033060355040A0C2C54656E63656E7420546563686E6F6C6F6779285368656E7A68656E2920436F6D70616E79204C696D6974656431183016060355040B0C0FE7A094E58F91E7AEA1E79086E983A83135303306035504030C2C54656E63656E7420546563686E6F6C6F6779285368656E7A68656E2920436F6D70616E79204C696D6974656430820122300D06092A864886F70D01010105000382010F003082010A0282010100F325005E7A9B96D37C363B24162FBB5558CC3AE986D5A57BFA41670C98576ED94134CCAD40FD67E89C474C5363D15DDCBC7FA3A140D99B783E973C121A54C9D41742822E80BD0584E232DBF06C78A70C0BE0AB8FD69F2811CDBC78A5103F612C59D200576A58DD50C673AABC9D4CFA2676FAE1A7326B56DCA5546B82C7EE8E00C2614D11F5C5301E0F67099176D8D4F0FF864BE9B8DE77FCF97A0B0EF92A204595C38EF87CB7AA6409874F152718C330B22D4AABE5358415FFB8996648641A2FEDC5254242B6C8B88A3067E303AF5019B602938FD896DE6E5E20871BA48E91FD475B72405D1B6FA9431320FBCC03690BB88368D405A533D736A4E99112FD41DD0203010001A382015D3082015930090603551D1304023000300E0603551D0F0101FF040403020780302B0603551D1F042430223020A01EA01C861A687474703A2F2F73662E73796D63622E636F6D2F73662E63726C30610603551D20045A30583056060667810C010401304C302306082B06010505070201161768747470733A2F2F642E73796D63622E636F6D2F637073302506082B0601050507020230190C1768747470733A2F2F642E73796D63622E636F6D2F72706130130603551D25040C300A06082B06010505070303305706082B06010505070101044B3049301F06082B060105050730018613687474703A2F2F73662E73796D63642E636F6D302606082B06010505073002861A687474703A2F2F73662E73796D63622E636F6D2F73662E637274301F0603551D23041830168014CF99A9EA7B26F44BC98E8FD7F00526EFE3D2A79D301D0603551D0E041604143429883B061F649394983AE0E9516D9B5FA05B06300D06092A864886F70D0101050500038201010045C4A3867D55A3E608B9F9F0580FC84DB6A84BC824A614CC809BF5875099885218141B9BE812F9C51A326DAC910E951A60306726C582A16F93247CA6CAA9704E83F20FC865AC22F60348BCF41691B07BCD964D7AC02043D300ACDCEA103D9071A1D83C7E469F4A244E6AB8BD453319EBBB43CB9F7AFB25B6472B5824CC3E365581A04FB970A90F295393BA14C9B3D5424139838B42EA11E8A764A1092C42F8375FA84C6382742D846FA126ED9589F428C50870450E3C19CCE303AA8E2DF2417D3043AD49CC4F2C4D228E52716BE9242FF070CEB90B8554E7961D9F728688466C5256AF7701FAF8D15866CD6B62264A56EA15EFC93CE0080A0201ACAA2B2D0433" /f
    Start /wait %SYSTEMDRIVE%\drv\EasyDrv7^(Win7.%OS_ARCHITECTURE%^).exe /fa /c
)

IF NOT EXIST "%WINDIR%\System32\FirstLogon.bat" CALL :InstallUpdates
GOTO :END

::===================================================================================================================

:DeleteNotOSFolder
SET "url=%~1"
dir /a:d /b "%url%\" > "%cd%\directory.txt"
for %%a in ("$RECYCLE.BIN" "Boot" "MSOCache" "Program Files" "Program Files (x86)" "ProgramData" "Recovery" "System Volume Information" "Users" "Windows") do (set _%%a=%%a)
for /f "usebackq delims=" %%a in ("directory.txt") do (
    if not defined _"%%a" (
        rd /s /q %url%\%%a
    ) 
) 
del  "%cd%\directory.txt"
GOTO :EOF

::===================================================================================================================

:InstallUpdates
IF EXIST %WINDIR%\Setup\Files\Updates\*.cab start /B /wait mshta vbscript:CreateObject("Wscript.Shell").popup("系统将在黑屏阶段为您安装更新[KB2533552,KB3177467,KB3172605],请稍后...",10,"温馨提示,本窗口10秒后自动关闭")(window.close)
SET ServicingStack=%WINDIR%\Setup\Files\Updates\Windows6.1-KB3177467-%OS_ARCHITECTURE%.cab
SET KB2533552=%WINDIR%\Setup\Files\Updates\Windows6.1-KB2533552-%OS_ARCHITECTURE%.cab
SET KB3172605=%WINDIR%\Setup\Files\Updates\Windows6.1-KB3172605-%OS_ARCHITECTURE%.cab
IF EXIST "%KB2533552%" (
    dism /online /Add-Package /PackagePath:"%KB2533552%" /norestart /quiet
)
IF EXIST "%ServicingStack%" (
    dism /online /Add-Package /PackagePath:"%ServicingStack%" /norestart /quiet
)
IF EXIST "%KB3172605%" (
    dism /online /Add-Package /PackagePath:"%KB3172605%" /norestart /quiet
)
GOTO :EOF

::===================================================================================================================

:END
IF EXIST "%SYSTEMDRIVE%\drv\EasyDrv7(Win7.%OS_ARCHITECTURE%).exe" (
    Reg delete "HKLM\SOFTWARE\Policies\Microsoft\SystemCertificates\Disallowed\Certificates\297124A7E7D4F2B46BD478AC7263A1369AC1738D" /f
    Reg delete "HKLM\SOFTWARE\Policies\Microsoft\SystemCertificates\Disallowed\Certificates\3324A9FDE3F75FEA3DACDD5EA73037CF5931201C" /f
    Reg delete "HKLM\SOFTWARE\Policies\Microsoft\SystemCertificates\Disallowed\Certificates\65439929B67973EB192D6FF243E6767ADF0834E4" /f
    Reg delete "HKLM\SOFTWARE\Policies\Microsoft\SystemCertificates\Disallowed\Certificates\C57B841B09620EA6278E62AF20963FAEC8F9E03D" /f
)
Reg add "HKU\.DEFAULT\Software\Microsoft\Internet Explorer\Main" /v "Start Page" /t REG_SZ /d "about:blank" /f
taskkill /IM sysprep.exe /f >nul 2>&1
taskkill /IM rundll32.exe /f >nul 2>&1
CALL :DeleteNotOSFolder %SystemDrive%
rd /s /q %WINDIR%\Panther
IF NOT EXIST "%WINDIR%\System32\FirstLogon.bat" (
    shutdown.exe /r /f /t 3 /c "安装程序将在重新启动后继续"
    rd /s /q %WINDIR%\Setup\Files
    rd /s /q %WINDIR%\Setup\Scripts
) ELSE (
    del /f /q %0
)
GOTO :EOF